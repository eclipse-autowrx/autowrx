<html>

<head>
  <script defer src="../syncer.js"></script>
  <style>
    @font-face {
      font-family: 'Manrope';
      src: url('../Manrope-VariableFont.ttf') format('truetype');
      font-weight: 100 900;
      font-display: swap;
    }

    body {
      font-family: 'Manrope', sans-serif;
      display: flex;
      flex-direction: column;
      background-color: white;
      height: 100%;
      width: 100%;
      overflow: auto;
      color: #1f2937;
      margin: 0;
    }

    .text-big {
      font-size: 13px !important;
    }

    .text-content {
      font-size: 12px !important;
    }

    .rtl {
      direction: rtl;
      text-overflow: ellipsis;
    }

    .table-auto {
      width: 100%;
      border-collapse: collapse;
    }

    .px-2 {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }

    .py-1 {
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
    }

    .font-semibold {
      font-weight: 600;
    }

    .font-bold {
      font-weight: 700;
    }

    .whitespace-nowrap {
      white-space: nowrap;
    }

    .bg-gray-50 {
      background-color: #f9fafb;
    }

    .bg-gray-100 {
      background-color: #f3f4f6;
    }
    
    .bg-slate-200 {
      background-color: #e2e8f0;
    }

    .text-gray-600 {
      color: #4b5563;
    }
    
    .text-gray-800 {
      color: #1f2937;
    }
    
    .text-slate-600 {
      color: #475569;
    }
    
    .text-slate-400 {
      color: #94a3b8;
    }

    .text-blue-700 {
      color: #1d4ed8;
    }
    
    .bg-green-400 {
      background-color: #4ade80;
    }
    
    .bg-red-400 {
      background-color: #f87171;
    }
    
    .text-white {
      color: white;
    }
    
    .border-slate-200 {
      border-color: #e2e8f0;
    }
    
    .border-slate-400 {
      border-color: #94a3b8;
    }

    input[type="text"], input[type="number"] {
      border: 1px solid #d1d5db;
      border-radius: 0.25rem;
      padding: 0.25rem 0.5rem;
      font-size: 12px;
      width: 100%;
    }

    button {
      background-color: #3b82f6;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 0.25rem;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }

    button:hover {
      background-color: #2563eb;
    }

    .flex {
      display: flex;
    }

    .items-center {
      align-items: center;
    }

    .gap-2 {
      gap: 0.5rem;
    }
    
    .space-x-1 > * + * {
      margin-left: 0.25rem;
    }
    
    .rounded {
      border-radius: 0.25rem;
    }
    
    .hover\:opacity-60:hover {
      opacity: 0.6;
    }
    
    .leading-tight {
      line-height: 1.25;
    }
    
    .whitespace-pre-wrap {
      white-space: pre-wrap;
    }
    
    .font-normal {
      font-weight: 400;
    }
    
    .text-center {
      text-align: center;
    }
    
    .text-right {
      text-align: right;
    }
    
    .justify-center {
      justify-content: center;
    }
    
    .justify-start {
      justify-content: start;
    }
    
    .overflow-x-hidden {
      overflow-x: hidden;
    }
    
    select {
      cursor: pointer;
    }
    
    .break-words {
      word-wrap: break-word;
      word-break: break-word;
    }
    
    .flex-wrap {
      flex-wrap: wrap;
    }
    
    .max-w-\[12vw\] {
      max-width: 12vw;
    }
    
    .max-w-\[14vw\] {
      max-width: 14vw;
    }
    
    .w-\[14vw\] {
      width: 14vw;
    }
    
    .min-w-\[14vw\] {
      min-width: 14vw;
    }
    
    .w-\[12vw\] {
      width: 12vw;
    }
    
    .min-w-\[12vw\] {
      min-width: 12vw;
    }
    
    .w-\[6vw\] {
      width: 6vw;
    }
    
    .w-\[70vw\] {
      width: 70vw;
    }
    
    .max-w-\[70vw\] {
      max-width: 70vw;
    }
  </style>
</head>

<body>

  <table id="api-table" class="table-auto">
    <tbody>
      <!-- Dynamic content will be inserted here -->
    </tbody>
  </table>

  <script>
    let VSS_JSON_URL = "./vss.json"
    let VSS_TREE = {}
    let VSS_LIST = []
    let VSS_MAP = new Map()

    function isNumber(value) {
      const numberPattern = /^-?\d+(\.\d+)?$/;
      return numberPattern.test(value);
    }

    function isFloat(value) {
      return Number.isFinite(value) && value !== Math.floor(value);
    }

    const convertTree2List = (vssTree) => {
      // console.log("vssTree", vssTree)
      const traverse = (
        node,
        prefix = 'Vehicle',
      ) => {
        let result = []
        if (node.type != "branch") {
          VSS_MAP.set(prefix, { ...node, name: prefix })
          result.push({ ...node, name: prefix })
        }

        if (node.children) {
          for (const [key, child] of Object.entries(node.children)) {
            const newPrefix = `${prefix}.${key}`
            node.children[key].name = newPrefix
            result = result.concat(traverse(child, newPrefix))
          }
        }

        return result
      }
      const keys = Object.keys(vssTree);
      if (keys.length > 0) {
        return traverse(vssTree[keys[0]], keys[0])
      }
      return []

    }

    const loadVssJson = async () => {
      if (VSS_JSON_URL) {
        try {
          let response = await fetch(VSS_JSON_URL)
          VSS_TREE = await response.json()
        } catch (err) {
          console.log("Err when load json file")
          console.log(err)
        }
      }
    }

    let interval = null;
    function getAllows(allows) {
      if (!allows) return ''
      return `<p class='text-content text-slate-400 font-semibold'>Allows values: ${allows.join(', ')}</p>`
    }
    function createTableCell(signal, content, col) {
      const cell = document.createElement('td');
      switch (col) {
        case 0:
          cell.className = `px-1 py-2 w-[70vw] max-w-[70vw] font-semibold text-big`;
          if (signal) {
            cell.innerHTML = `<div class='w-full'>
                <div class='w-full flex justify-start'>
                  <div class='font-semibold text-slate-600 break-words'>${content}</div>
                </div>
                <p class='w-full text-content text-slate-600 font-normal flex flex-wrap leading-tight'> [${signal.type.toUpperCase()}] [${signal.datatype}] ${signal.unit ? ("[" + signal.unit + "]") : ''} ${signal.description}</p>
                </div>`
          } else {
            cell.innerHTML = `<div class='w-full flex justify-start'>
                <div class='font-semibold text-slate-600 break-words'>${content}</div>
              </div>`
          }

          break;
        case 1:
          cell.className = `ml-1 px-1 py-1 text-center w-[12vw] min-w-[12vw] rounded whitespace-nowrap text-content font-semibold`;
          cell.innerText = content;
          break;
        case 2:
          cell.className = `px-1 py-1 w-[14vw] min-w-[14vw] text-center`;
          if (signal && signal.datatype == 'boolean') {
            const container = document.createElement('div');
            container.className = 'flex space-x-1 justify-center'

            const btn_on = document.createElement('button');
            btn_on.className = `text-big rounded w-[6vw] py-0.5 flex justify-center bg-green-400 text-white hover:opacity-60`
            btn_on.innerText = "ON"
            container.appendChild(btn_on)
            const btn_off = document.createElement('button');
            btn_off.className = `text-big rounded w-[6vw] py-0.5 flex justify-center bg-red-400 text-white hover:opacity-60`
            btn_off.innerText = "OFF"
            container.appendChild(btn_off)

            btn_on.addEventListener("click", (e) => {
              setApiValue(content, true)
            })

            btn_off.addEventListener("click", (e) => {
              setApiValue(content, false)
            })

            cell.appendChild(container)
          } else if (signal && signal.datatype == 'string' && signal.allowed) {
            const container = document.createElement('div');
            container.className = 'flex w-full justify-center'
            const tag_select = document.createElement('select');
            tag_select.className = "px-1 py-1 rounded border border-slate-200 w-full max-w-[12vw] text-content font-semibold text-center"
            signal.allowed.forEach(v => {
              let opt = document.createElement('option');
              opt.value = v;
              opt.innerHTML = v;
              tag_select.appendChild(opt);
            })
            tag_select.addEventListener("change", function () {
              console.log(`tag_select VALUE ${tag_select.value}`)
              setApiValue(content, tag_select.value)
            });
            cell.appendChild(container)
          } else {
            const container = document.createElement('div');
            container.className = 'flex w-full justify-center'
            const input = document.createElement('input');
            input.className = `rounded w-full max-w-[12vw] border border-slate-400 bg-white px-1 py-1 text-center`
            try {
              input.addEventListener("keydown", (e) => {
                if (e.keyCode == 13) {
                  let value = e.target.value
                  let sendValue = 0
                  if (value.length > 0) {
                    if ((signal && signal.datatype == 'string') || !isNumber(value.trim())) {
                      setApiValue(content, value.trim())
                    } else {
                      setApiValue(content, Number(value.trim()))
                    }
                    //setApiValue(content, sendValue)
                    e.target.value = ""
                  }
                }
              })
            } catch (ex) {
            }

            container.appendChild(input)
            cell.appendChild(container)
          }

          break;
        case 3:
          // create range note
          cell.className = `px-4 py-2 font-semibold whitespace-nowrap`;
          cell.innerText = "";
          if (signal) {
            cell.innerText = `[${signal.datatype}] ${signal.type}`;
          }
          break;
        default:
          cell.className = `ml-1 px-4 py-2`
          break;
      }

      return cell;
    }

    async function onWidgetLoaded(options) {
      //console.log(">>>>>>> onWidgetLoaded", options)
      const apiTableBody = document.querySelector('#api-table tbody');
      
      // Handle null options gracefully
      if (!options) {
        console.log("No options provided, using defaults");
        options = { apis: [] };
      }

      VSS_JSON_URL = options.vss_json

      if (VSS_JSON_URL) {
        await loadVssJson()
      } else {
        await new Promise(r => setTimeout(r, 500))

        //console.log("window.VSS_TREE", window.VSS_TREE)
        if ("window.VSS_TREE", window.VSS_TREE) {
          VSS_TREE = window.VSS_TREE
        }
      }
      //console.log(VSS_TREE)
      VSS_LIST = convertTree2List(VSS_TREE)

      if (options.apis && Array.isArray(options.apis)) {
        const rowHead = document.createElement('tr');
        rowHead.className = "bg-slate-200 text-big"
        const td0 = document.createElement('td');
        td0.innerText = "Signal"
        td0.className = "px-4 py-1 font-bold text-center"
        const td1 = document.createElement('td');
        td1.innerText = "Value"
        td1.className = "px-4 py-1 font-bold text-center"
        const td2 = document.createElement('td');
        td2.innerText = "Set"
        td2.className = "px-4 py-1 font-bold text-center"
        // const td3 = document.createElement('td');
        // td3.innerText = "Remark"
        // td3.className = "px-4 py-1 font-bold text-lg text-center"
        rowHead.appendChild(td0)
        rowHead.appendChild(td1)
        rowHead.appendChild(td2)
        // rowHead.appendChild(td3)
        apiTableBody.appendChild(rowHead)

        options.apis.forEach((api, index) => {
          const row = document.createElement('tr');
          row.className = index % 2 === 1 ? 'bg-gray-50' : 'bg-gray-100';
          let signal = VSS_MAP.get(api)
          console.log(`signal ${api}`, signal)
          row.appendChild(createTableCell(signal, api, 0));
          row.appendChild(createTableCell(signal, '0', 1));
          row.appendChild(createTableCell(signal, api, 2));
          // row.appendChild(createTableCell(signal, api, 3));
          apiTableBody.appendChild(row);
        });

        interval = setInterval(() => {
          options.apis.forEach((api, index) => {
            //if(index==0) return
            let apiValueObject = getApiValue(api);
            let apiValue = apiValueObject?.value == undefined ? 'NaN' : apiValueObject?.value;
            if (isFloat(apiValue)) {
              apiValue = Number(apiValue.toFixed(3))
            }
            apiTableBody.rows[index + 1].cells[1].innerText = apiValue;
            apiTableBody.rows[index + 1].cells[1].title = apiValue;
          });
        }, 100);
      }
    }

    function onWidgetUnloaded(options) {
      if (interval) clearInterval(interval);
    }

  </script>
</body>

</html>