name: Build Docker Image

on:
  workflow_dispatch:
    inputs:
      custom_tag:
        description: 'Custom tag for the image (e.g., v1.2.3, release-2024-01-15)'
        required: false
        type: string
        default: ''
      branch:
        description: 'Branch to build (leave empty for current branch)'
        required: false
        type: string
        default: ''
      push_image:
        description: 'Push image to registry'
        required: false
        type: boolean
        default: true
  push:
    tags:
      - 'v*'
      - '**'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  test-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/autowrx
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=test-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.custom_tag }},enable=${{ github.event.inputs.custom_tag != '' }}

      - name: Determine if should push
        id: should_push
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            echo "push=true" >> $GITHUB_OUTPUT
            echo "Triggered by tag push, will push image"
          elif [[ "${{ github.event.inputs.push_image }}" == "true" ]] || [[ "${{ github.event.inputs.push_image }}" == true ]]; then
            echo "push=true" >> $GITHUB_OUTPUT
            echo "Manual trigger with push_image=true"
          else
            echo "push=false" >> $GITHUB_OUTPUT
            echo "Manual trigger with push_image=false, will not push"
          fi

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ steps.should_push.outputs.push == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test result
        run: |
          echo "=========================================="
          echo "✓ Build completed successfully"
          echo "=========================================="
          echo ""
          echo "Trigger: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "Ref: ${{ github.ref }}"
            echo "Ref type: ${{ github.ref_type }}"
            if [[ "${{ github.ref_type }}" == "tag" ]]; then
              echo "Tag: ${{ github.ref_name }}"
            fi
          else
            echo "Branch: ${{ github.event.inputs.branch || github.ref_name }}"
            if [[ -n "${{ github.event.inputs.custom_tag }}" ]]; then
              echo "Custom tag: ${{ github.event.inputs.custom_tag }}"
            fi
            echo "Push image: ${{ github.event.inputs.push_image }}"
          fi
          echo ""
          echo "Pushed to registry: ${{ steps.should_push.outputs.push }}"
          echo "Image tags:"
          echo "${{ steps.meta.outputs.tags }}"
          echo ""
          if [[ "${{ steps.should_push.outputs.push }}" == "true" ]]; then
            if [[ -n "${{ github.event.inputs.custom_tag }}" ]]; then
              echo "Custom tagged image is available:"
              echo "  ghcr.io/${{ env.IMAGE_PREFIX }}/autowrx:${{ github.event.inputs.custom_tag }}"
              echo ""
              echo "You can now use this image in production by updating .env.stack:"
              echo "IMAGE_TAG=${{ github.event.inputs.custom_tag }}"
            elif [[ "${{ github.ref_type }}" == "tag" ]]; then
              echo "Tagged image is available:"
              echo "  ghcr.io/${{ env.IMAGE_PREFIX }}/autowrx:${{ github.ref_name }}"
              echo ""
              echo "You can now use this image in production by updating .env.stack:"
              echo "IMAGE_TAG=${{ github.ref_name }}"
            else
              echo "You can now test this image by updating .env.stack:"
              echo "IMAGE_TAG=test-${GITHUB_SHA:0:7}"
            fi
          else
            echo "Image was built but not pushed (test only)"
          fi

  release-instance-setup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event_name == 'push' && github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract tag name
        id: tag
        run: |
          RELEASE_TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
          echo "Release tag: $RELEASE_TAG"

      - name: Verify instance-setup directory exists
        run: |
          if [ ! -d "instance-setup" ]; then
            echo "Error: instance-setup directory not found"
            exit 1
          fi
          ls -la instance-setup/

      - name: Create instance-setup tarball
        run: |
          cd instance-setup
          tar -czf ../instance-setup-${{ env.RELEASE_TAG }}.tar.gz .
          cd ..
          echo "Created: instance-setup-${{ env.RELEASE_TAG }}.tar.gz"
          ls -lh instance-setup-${{ env.RELEASE_TAG }}.tar.gz

      - name: Create individual file copies for easy access
        run: |
          mkdir -p release-files
          cp instance-setup/docker-compose.prod.yml release-files/docker-compose.prod.yml
          cp instance-setup/.env.prod.sample release-files/.env.prod.sample
          cp instance-setup/up.sh release-files/up.sh
          cp instance-setup/down.sh release-files/down.sh
          cp instance-setup/instance-setup-guide.md release-files/instance-setup-guide.md
          echo "Created individual file copies"

      - name: Create GitHub Release with assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          body: |
            ## Instance Setup Files
            
            Download the complete instance-setup directory or individual files:
            
            ### Complete Package
            - **instance-setup-${{ env.RELEASE_TAG }}.tar.gz** - Complete instance-setup directory
            
            ### Individual Files
            - **docker-compose.prod.yml** - Docker Compose configuration
            - **.env.prod.sample** - Environment variables template
            - **up.sh** - Start script
            - **down.sh** - Stop script
            - **instance-setup-guide.md** - Setup guide
            
            ### Quick Start
            
            ```bash
            # Download and extract the complete package
            wget https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/instance-setup-${{ env.RELEASE_TAG }}.tar.gz
            tar -xzf instance-setup-${{ env.RELEASE_TAG }}.tar.gz
            cd instance-setup
            cp .env.prod.sample .env.prod
            # Edit .env.prod with your configuration
            ./up.sh
            ```
            
            Or download individual files:
            
            ```bash
            # Download docker-compose.prod.yml
            wget https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/docker-compose.prod.yml
            ```
          files: |
            instance-setup-${{ env.RELEASE_TAG }}.tar.gz
            release-files/docker-compose.prod.yml
            release-files/.env.prod.sample
            release-files/up.sh
            release-files/down.sh
            release-files/instance-setup-guide.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display download URLs
        run: |
          echo "=========================================="
          echo "✓ Instance setup files released successfully"
          echo "=========================================="
          echo ""
          echo "Release tag: ${{ env.RELEASE_TAG }}"
          echo ""
          echo "Download URLs:"
          echo "  Complete package:"
          echo "    https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/instance-setup-${{ env.RELEASE_TAG }}.tar.gz"
          echo ""
          echo "  Individual files:"
          echo "    https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/docker-compose.prod.yml"
          echo "    https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/.env.prod.sample"
          echo "    https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/up.sh"
          echo "    https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/down.sh"
          echo "    https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/instance-setup-guide.md"